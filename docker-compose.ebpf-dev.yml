version: '3.8'

services:
  ebpf-dev:
    build:
      context: .
      dockerfile: docker/Dockerfile.ebpf-dev
    container_name: go-net-monitoring-ebpf-dev
    volumes:
      - .:/workspace
      - go-mod-cache:/go/pkg/mod
    working_dir: /workspace
    stdin_open: true
    tty: true
    privileged: true  # eBPFéœ€è¦ç‰¹æƒæ¨¡å¼
    network_mode: host
    environment:
      - GOPROXY=https://goproxy.cn,direct
      - GO111MODULE=on
      - GOSUMDB=sum.golang.google.cn
    command: /bin/bash

  # eBPFç¼–è¯‘æœåŠ¡
  ebpf-build:
    build:
      context: .
      dockerfile: docker/Dockerfile.ebpf-dev
    container_name: go-net-monitoring-ebpf-build
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - GOPROXY=https://goproxy.cn,direct
      - GO111MODULE=on
      - GOSUMDB=sum.golang.google.cn
    command: >
      bash -c "
        echo 'ðŸ”¨ Building eBPF programs...' &&
        cd bpf &&
        make clean &&
        make all &&
        make verify &&
        echo 'âœ… eBPF build completed!'
      "

  # å¿«é€Ÿæµ‹è¯•æœåŠ¡
  ebpf-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.ebpf-dev
    container_name: go-net-monitoring-ebpf-test
    volumes:
      - .:/workspace
    working_dir: /workspace
    environment:
      - GOPROXY=https://goproxy.cn,direct
      - GO111MODULE=on
    command: >
      bash -c "
        echo 'ðŸ§ª Testing eBPF environment...' &&
        cd bpf &&
        make test-env &&
        echo 'ðŸ”§ Building Go program...' &&
        cd .. &&
        go mod tidy &&
        go build -o bin/ebpf-agent ./cmd/ebpf-agent/ &&
        echo 'âœ… Test completed!'
      "

volumes:
  go-mod-cache:
