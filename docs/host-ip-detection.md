# ä¸»æœºIPæ£€æµ‹åŠŸèƒ½

## æ¦‚è¿°

ç½‘ç»œæµé‡ç›‘æ§ç³»ç»Ÿç°åœ¨æ”¯æŒä¸»æœºIPæ£€æµ‹åŠŸèƒ½ï¼Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«å®¹å™¨ç¯å¢ƒå¹¶è·å–ä¸»æœºIPåœ°å€ã€‚è¿™ä¸ªåŠŸèƒ½é€šè¿‡åœ¨ `network_interface_info` æŒ‡æ ‡ä¸­æ·»åŠ  `host_ip_address` æ ‡ç­¾æ¥å®ç°ï¼Œå¸®åŠ©ç”¨æˆ·åŒºåˆ†è™šæ‹Ÿæœºå’Œç‰©ç†æœºç¯å¢ƒã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹
- **å®¹å™¨æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«Dockerã€Podmanã€LXCç­‰å®¹å™¨ç¯å¢ƒ
- **è™šæ‹Ÿæœºæ£€æµ‹**: è¯†åˆ«VMwareã€VirtualBoxã€KVMã€QEMUç­‰è™šæ‹ŸåŒ–ç¯å¢ƒ
- **ä¸»æœºIPè·å–**: è·å–å®¹å™¨å®¿ä¸»æœºçš„çœŸå®IPåœ°å€

### ğŸ“Š æŒ‡æ ‡å¢å¼º
- **æ–°å¢æ ‡ç­¾**: `host_ip_address` - ä¸»æœºIPåœ°å€ï¼ˆä»…åœ¨å®¹å™¨ç¯å¢ƒä¸­æœ‰å€¼ï¼‰
- **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰æŒ‡æ ‡æ ¼å¼ä¸å˜
- **æ™ºèƒ½å¡«å……**: éå®¹å™¨ç¯å¢ƒä¸­è¯¥æ ‡ç­¾ä¸ºç©ºå­—ç¬¦ä¸²

## æŒ‡æ ‡æ ¼å¼

### æ›´æ–°åçš„ network_interface_info æŒ‡æ ‡

```prometheus
# HELP network_interface_info Network interface information with IP address, MAC address and host IP address
# TYPE network_interface_info gauge
network_interface_info{host="container_id",host_ip_address="192.168.1.100",interface="eth0",ip_address="172.17.0.2",mac_address="02:42:ac:11:00:02"} 1
```

### æ ‡ç­¾è¯´æ˜

| æ ‡ç­¾å | æè¿° | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `host` | å®¹å™¨IDæˆ–ä¸»æœºå | `4a0e1a7a7fc4` |
| `interface` | ç½‘ç»œæ¥å£åç§° | `eth0` |
| `ip_address` | æ¥å£IPåœ°å€ | `172.17.0.2` |
| `mac_address` | MACåœ°å€ | `02:42:ac:11:00:02` |
| `host_ip_address` | ä¸»æœºIPåœ°å€ | `192.168.1.100` |

## ä½¿ç”¨åœºæ™¯

### 1. åŒºåˆ†è™šæ‹Ÿæœºå’Œç‰©ç†æœº

```promql
# æŸ¥è¯¢æ‰€æœ‰å®¹å™¨/è™šæ‹Ÿæœºç½‘å¡ä¿¡æ¯
network_interface_info{host_ip_address!=""}

# æŸ¥è¯¢ç‰©ç†æœºç½‘å¡ä¿¡æ¯
network_interface_info{host_ip_address=""}
```

### 2. æŒ‰ä¸»æœºIPåˆ†ç»„ç»Ÿè®¡

```promql
# ç»Ÿè®¡æ¯ä¸ªä¸»æœºä¸Šçš„å®¹å™¨æ•°é‡
count by (host_ip_address) (network_interface_info{host_ip_address!=""})

# æŸ¥çœ‹ç‰¹å®šä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨
network_interface_info{host_ip_address="192.168.1.100"}
```

### 3. ç½‘ç»œæ‹“æ‰‘åˆ†æ

```promql
# åˆ†æå®¹å™¨ç½‘ç»œåˆ†å¸ƒ
group by (host_ip_address, ip_address) (network_interface_info)

# æŸ¥æ‰¾è·¨ä¸»æœºé€šä¿¡
network_domains_accessed_total * on(host) group_left(host_ip_address) network_interface_info
```

## æ£€æµ‹é€»è¾‘

### å®¹å™¨ç¯å¢ƒæ£€æµ‹

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹æ³•æ£€æµ‹å®¹å™¨ç¯å¢ƒï¼š

1. **æ–‡ä»¶æ£€æµ‹**
   - æ£€æŸ¥ `/.dockerenv` æ–‡ä»¶ï¼ˆDockerï¼‰
   - æ£€æŸ¥ `/proc/1/cgroup` å†…å®¹
   - æ£€æŸ¥ `/proc/self/mountinfo` å†…å®¹

2. **ç¯å¢ƒå˜é‡æ£€æµ‹**
   - æ£€æŸ¥ `container` ç¯å¢ƒå˜é‡

3. **æ”¯æŒçš„å®¹å™¨ç±»å‹**
   - Docker
   - Podman
   - Containerd
   - LXC

### è™šæ‹Ÿæœºç¯å¢ƒæ£€æµ‹

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹æ³•æ£€æµ‹è™šæ‹Ÿæœºç¯å¢ƒï¼š

1. **DMIä¿¡æ¯æ£€æµ‹**
   - æ£€æŸ¥ `/sys/class/dmi/id/product_name`
   - æ£€æŸ¥ `/sys/class/dmi/id/sys_vendor`

2. **CPUä¿¡æ¯æ£€æµ‹**
   - æ£€æŸ¥ `/proc/cpuinfo` ä¸­çš„hypervisoræ ‡å¿—

3. **æ”¯æŒçš„è™šæ‹ŸåŒ–ç±»å‹**
   - VMware
   - VirtualBox
   - KVM/QEMU
   - Xen
   - Hyper-V

### ä¸»æœºIPè·å–

ç³»ç»Ÿä½¿ç”¨å¤šç§æ–¹æ³•è·å–ä¸»æœºIPï¼š

1. **UDPè¿æ¥æ³•**: é€šè¿‡è¿æ¥å¤–éƒ¨åœ°å€è·å–æœ¬åœ°IP
2. **è·¯ç”±è¡¨æ³•**: ä» `/proc/net/route` è·å–é»˜è®¤è·¯ç”±å¯¹åº”çš„IP
3. **æ¥å£éå†æ³•**: è·å–ç¬¬ä¸€ä¸ªéå›ç¯çš„IPv4åœ°å€

## é…ç½®é€‰é¡¹

ç›®å‰ä¸»æœºIPæ£€æµ‹åŠŸèƒ½æ˜¯è‡ªåŠ¨å¯ç”¨çš„ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚ç³»ç»Ÿä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå¹¶è·å–ç›¸å…³ä¿¡æ¯ã€‚

## æ€§èƒ½å½±å“

- **æ£€æµ‹å¼€é”€**: ä¸»æœºæ£€æµ‹ä»…åœ¨å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè¿è¡Œæ—¶å¼€é”€æå°
- **å†…å­˜ä½¿ç”¨**: å¢åŠ çš„å†…å­˜ä½¿ç”¨é‡å¯å¿½ç•¥ä¸è®¡
- **ç½‘ç»œå¼€é”€**: æ— é¢å¤–ç½‘ç»œå¼€é”€

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **host_ip_address ä¸ºç©º**
   - åŸå› ï¼šç³»ç»Ÿæœªæ£€æµ‹åˆ°å®¹å™¨ç¯å¢ƒ
   - è§£å†³ï¼šæ£€æŸ¥å®¹å™¨è¿è¡Œç¯å¢ƒï¼Œç¡®è®¤æ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œ

2. **æ£€æµ‹åˆ°é”™è¯¯çš„ä¸»æœºIP**
   - åŸå› ï¼šç½‘ç»œé…ç½®å¤æ‚æˆ–å¤šç½‘å¡ç¯å¢ƒ
   - è§£å†³ï¼šæ£€æŸ¥è·¯ç”±è¡¨å’Œç½‘ç»œé…ç½®

3. **è™šæ‹Ÿæœºæ£€æµ‹å¤±è´¥**
   - åŸå› ï¼šè™šæ‹ŸåŒ–å¹³å°ä¸åœ¨æ”¯æŒåˆ—è¡¨ä¸­
   - è§£å†³ï¼šæ£€æŸ¥ `/sys/class/dmi/id/` ä¸‹çš„æ–‡ä»¶å†…å®¹

### è°ƒè¯•æ–¹æ³•

1. **å¯ç”¨è°ƒè¯•æ—¥å¿—**
   ```bash
   # å¯åŠ¨è°ƒè¯•æ¨¡å¼
   make docker-up-debug
   
   # æŸ¥çœ‹ä¸»æœºæ£€æµ‹æ—¥å¿—
   docker logs netmon-server | grep "Host detection"
   ```

2. **æ‰‹åŠ¨æµ‹è¯•æ£€æµ‹åŠŸèƒ½**
   ```bash
   # è¿è¡Œæµ‹è¯•è„šæœ¬
   go run test-host-detection.go
   ```

3. **éªŒè¯æŒ‡æ ‡è¾“å‡º**
   ```bash
   # æ£€æŸ¥æŒ‡æ ‡æ ¼å¼
   curl -s http://localhost:8080/metrics | grep network_interface_info
   ```

## ç¤ºä¾‹è¾“å‡º

### å®¹å™¨ç¯å¢ƒä¸­çš„æŒ‡æ ‡

```prometheus
network_interface_info{host="e8f91bc76c0e",host_ip_address="192.168.1.100",interface="eth0",ip_address="172.26.0.5",mac_address="02:42:ac:1a:00:05"} 1
```

### ç‰©ç†æœºç¯å¢ƒä¸­çš„æŒ‡æ ‡

```prometheus
network_interface_info{host="physical-server",host_ip_address="",interface="eth0",ip_address="192.168.1.100",mac_address="aa:bb:cc:dd:ee:ff"} 1
```

## æ›´æ–°æ—¥å¿—

- **v1.0.0**: åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒåŸºæœ¬çš„ä¸»æœºIPæ£€æµ‹
- **v1.1.0**: å¢åŠ è™šæ‹Ÿæœºç¯å¢ƒæ£€æµ‹
- **v1.2.0**: ä¼˜åŒ–IPè·å–é€»è¾‘ï¼Œæ”¯æŒå¤šç§æ£€æµ‹æ–¹æ³•

## ç›¸å…³æ–‡æ¡£

- [ç½‘ç»œç›‘æ§æŒ‡æ ‡è¯´æ˜](metrics.md)
- [Dockeréƒ¨ç½²æŒ‡å—](docker-deployment.md)
- [Prometheusé›†æˆæŒ‡å—](prometheus-integration.md)
