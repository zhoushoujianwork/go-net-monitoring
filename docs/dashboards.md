# Grafana Dashboard å±•ç¤ºæ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»ç½‘ç»œæµé‡ç›‘æ§ç³»ç»Ÿçš„ Grafana Dashboard åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚

## ğŸ¯ Dashboard æ¦‚è§ˆ

ç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªä¸“ä¸šçº§çš„ Grafana Dashboardï¼Œå…¨é¢æ”¯æŒå¤šè®¾å¤‡ç›‘æ§å’Œçµæ´»çš„æ•°æ®åˆ†æï¼š

| Dashboard | æ–‡ä»¶å | ç”¨é€” | ç‰¹ç‚¹ |
|-----------|--------|------|------|
| ç½‘ç»œç›‘æ§ - æ€»ä½“æ¦‚è§ˆ | `network-overview-complete.json` | å…¨å±€ç›‘æ§è§†å›¾ | æ±‡æ€»ç»Ÿè®¡ã€è®¾å¤‡çŠ¶æ€ã€çƒ­é—¨åŸŸå |
| ç½‘ç»œç›‘æ§ - è¯¦ç»†åˆ†æ | `network-detailed.json` | æ·±å…¥åˆ†æå·¥å…· | è®¾å¤‡é€‰æ‹©ã€ç½‘å¡è¿‡æ»¤ã€è¯¦ç»†ç»Ÿè®¡ |

## ğŸ“Š Dashboard è¯¦ç»†ä»‹ç»

### 1. ç½‘ç»œç›‘æ§ - æ€»ä½“æ¦‚è§ˆ

#### ğŸ¯ è®¾è®¡ç›®æ ‡
ä¸ºè¿ç»´äººå‘˜æä¾›ä¸€ä¸ªå…¨å±€çš„ç½‘ç»œç›‘æ§è§†å›¾ï¼Œå¿«é€Ÿäº†è§£æ•´ä½“ç½‘ç»œçŠ¶å†µå’Œè¯†åˆ«å¼‚å¸¸ã€‚

#### ğŸ“‹ é¢æ¿å¸ƒå±€

**å…¨å±€æ¦‚è§ˆåŒºåŸŸ**
- **ç›‘æ§è®¾å¤‡æ€»æ•°**: æ˜¾ç¤ºå½“å‰åœ¨çº¿çš„è®¾å¤‡æ•°é‡
- **å…¨ç½‘è¿æ¥é€Ÿç‡**: æ‰€æœ‰è®¾å¤‡çš„è¿æ¥å»ºç«‹é€Ÿç‡æ±‡æ€»
- **å…¨ç½‘å‘é€é€Ÿç‡**: æ‰€æœ‰è®¾å¤‡çš„æ•°æ®å‘é€é€Ÿç‡æ±‡æ€»  
- **å…¨ç½‘æ¥æ”¶é€Ÿç‡**: æ‰€æœ‰è®¾å¤‡çš„æ•°æ®æ¥æ”¶é€Ÿç‡æ±‡æ€»

**ç½‘ç»œæµé‡è¶‹åŠ¿åŒºåŸŸ**
- **ç½‘ç»œæµé‡é€Ÿç‡ - æŒ‰è®¾å¤‡**: æ—¶é—´åºåˆ—å›¾ï¼Œæ˜¾ç¤ºæ¯ä¸ªè®¾å¤‡çš„å‘é€/æ¥æ”¶é€Ÿç‡
- **ç½‘ç»œè¿æ¥é€Ÿç‡ - æŒ‰è®¾å¤‡**: æ—¶é—´åºåˆ—å›¾ï¼Œæ˜¾ç¤ºæ¯ä¸ªè®¾å¤‡çš„è¿æ¥å»ºç«‹é€Ÿç‡

**è®¾å¤‡çŠ¶æ€ç›‘æ§åŒºåŸŸ**
- **è®¾å¤‡å®æ—¶çŠ¶æ€è¡¨**: è¡¨æ ¼æ˜¾ç¤ºæ‰€æœ‰è®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯
  - ä¸»æœºåã€ç½‘å¡ã€IPåœ°å€ã€MACåœ°å€
  - å®æ—¶è¿æ¥é€Ÿç‡ã€å‘é€é€Ÿç‡ã€æ¥æ”¶é€Ÿç‡
  - åœ¨çº¿çŠ¶æ€æŒ‡ç¤º

**çƒ­é—¨åŸŸåè®¿é—®åŒºåŸŸ**
- **å…¨ç½‘åŸŸåè®¿é—®æ¬¡æ•° Top10**: é¥¼å›¾æ˜¾ç¤ºè®¿é—®æœ€é¢‘ç¹çš„åŸŸå
- **å…¨ç½‘åŸŸåå‘é€æµé‡ Top10**: é¥¼å›¾æ˜¾ç¤ºæµé‡æœ€å¤§çš„åŸŸå

#### ğŸ” ä½¿ç”¨åœºæ™¯

```bash
# åœºæ™¯1: å¿«é€Ÿå¥åº·æ£€æŸ¥
# æŸ¥çœ‹æ€»ä½“æ¦‚è§ˆé¢æ¿ï¼Œç¡®è®¤ï¼š
# - æ‰€æœ‰è®¾å¤‡éƒ½åœ¨çº¿
# - æµé‡é€Ÿç‡åœ¨æ­£å¸¸èŒƒå›´å†…
# - æ²¡æœ‰å¼‚å¸¸çš„è¿æ¥å³°å€¼

# åœºæ™¯2: å¼‚å¸¸æµé‡è¯†åˆ«
# é€šè¿‡æµé‡è¶‹åŠ¿å›¾å‘ç°ï¼š
# - æŸä¸ªè®¾å¤‡æµé‡å¼‚å¸¸å¢é•¿
# - ç‰¹å®šæ—¶é—´æ®µçš„æµé‡å³°å€¼
# - è®¾å¤‡é—´æµé‡åˆ†å¸ƒä¸å‡

# åœºæ™¯3: çƒ­é—¨åŸŸååˆ†æ
# é€šè¿‡åŸŸåæ’è¡Œæ¦œäº†è§£ï¼š
# - æœ€å¸¸è®¿é—®çš„å¤–éƒ¨æœåŠ¡
# - æµé‡æ¶ˆè€—æœ€å¤§çš„åŸŸå
# - å¯èƒ½çš„å¼‚å¸¸è®¿é—®è¡Œä¸º
```

### 2. ç½‘ç»œç›‘æ§ - è¯¦ç»†åˆ†æ

#### ğŸ¯ è®¾è®¡ç›®æ ‡
ä¸ºæŠ€æœ¯äººå‘˜æä¾›æ·±å…¥çš„åˆ†æå·¥å…·ï¼Œæ”¯æŒé’ˆå¯¹ç‰¹å®šè®¾å¤‡å’Œç½‘å¡è¿›è¡Œè¯¦ç»†çš„ç½‘ç»œè¡Œä¸ºåˆ†æã€‚

#### ğŸ”§ å˜é‡æ§åˆ¶å™¨

**ä¸»æœºé€‰æ‹©å™¨ (`$host`)**
- æ•°æ®æº: `label_values(network_interface_info, host)`
- æ”¯æŒå¤šé€‰å’Œ "All" é€‰é¡¹
- åŠ¨æ€æ›´æ–°å¯ç”¨ä¸»æœºåˆ—è¡¨

**ç½‘å¡é€‰æ‹©å™¨ (`$interface`)**  
- æ•°æ®æº: `label_values(network_interface_info{host=~"$host"}, interface)`
- æ ¹æ®é€‰æ‹©çš„ä¸»æœºåŠ¨æ€è¿‡æ»¤ç½‘å¡
- æ”¯æŒå¤šé€‰å’Œ "All" é€‰é¡¹

#### ğŸ“‹ é¢æ¿å¸ƒå±€

**æ¦‚è§ˆç»Ÿè®¡åŒºåŸŸ**
- **åœ¨çº¿è®¾å¤‡æ•°**: æ ¹æ®è¿‡æ»¤æ¡ä»¶æ˜¾ç¤ºè®¾å¤‡æ•°é‡
- **å½“å‰è¿æ¥é€Ÿç‡**: è¿‡æ»¤åè®¾å¤‡çš„è¿æ¥é€Ÿç‡æ±‡æ€»
- **å½“å‰å‘é€é€Ÿç‡**: è¿‡æ»¤åè®¾å¤‡çš„å‘é€é€Ÿç‡æ±‡æ€»
- **å½“å‰æ¥æ”¶é€Ÿç‡**: è¿‡æ»¤åè®¾å¤‡çš„æ¥æ”¶é€Ÿç‡æ±‡æ€»

**è®¾å¤‡ä¿¡æ¯åŒºåŸŸ**
- **è®¾å¤‡ç½‘å¡ä¿¡æ¯è¡¨**: æ˜¾ç¤ºè¿‡æ»¤åè®¾å¤‡çš„è¯¦ç»†ä¿¡æ¯
  - ä¸»æœºåã€ç½‘å¡ã€IPåœ°å€ã€MACåœ°å€ã€åœ¨çº¿çŠ¶æ€

**ç½‘ç»œæµé‡è¶‹åŠ¿åŒºåŸŸ**
- **ç½‘ç»œæµé‡é€Ÿç‡**: æ—¶é—´åºåˆ—å›¾ï¼ŒæŒ‰ä¸»æœº-ç½‘å¡æ˜¾ç¤ºæµé‡è¶‹åŠ¿
- **ç½‘ç»œè¿æ¥é€Ÿç‡**: æ—¶é—´åºåˆ—å›¾ï¼ŒæŒ‰ä¸»æœº-ç½‘å¡æ˜¾ç¤ºè¿æ¥è¶‹åŠ¿

**åŸŸåè®¿é—®åˆ†æåŒºåŸŸ**
- **åŸŸåè®¿é—®æ¬¡æ•° Top10**: é¥¼å›¾ï¼Œè¿‡æ»¤åè®¾å¤‡çš„åŸŸåè®¿é—®æ’è¡Œ
- **åŸŸåå‘é€æµé‡ Top10**: é¥¼å›¾ï¼Œè¿‡æ»¤åè®¾å¤‡çš„åŸŸåæµé‡æ’è¡Œ
- **åŸŸåè®¿é—®è¯¦ç»†ç»Ÿè®¡è¡¨**: å®Œæ•´çš„åŸŸåç»Ÿè®¡æ•°æ®
  - åŸŸåã€ä¸»æœºã€ç½‘å¡ã€è®¿é—®æ¬¡æ•°ã€å‘é€/æ¥æ”¶å­—èŠ‚æ•°

#### ğŸ” ä½¿ç”¨åœºæ™¯

```bash
# åœºæ™¯1: ç‰¹å®šè®¾å¤‡é—®é¢˜æ’æŸ¥
# 1. é€‰æ‹©é—®é¢˜è®¾å¤‡: host = "problematic-server"
# 2. æŸ¥çœ‹è¯¥è®¾å¤‡çš„æµé‡è¶‹åŠ¿
# 3. åˆ†æåŸŸåè®¿é—®æ¨¡å¼
# 4. è¯†åˆ«å¼‚å¸¸çš„ç½‘ç»œè¡Œä¸º

# åœºæ™¯2: ç½‘å¡æ€§èƒ½åˆ†æ
# 1. é€‰æ‹©ç‰¹å®šç½‘å¡: interface = "eth0"
# 2. å¯¹æ¯”ä¸åŒä¸»æœºä¸ŠåŒä¸€ç½‘å¡çš„æ€§èƒ½
# 3. è¯†åˆ«ç½‘å¡ç“¶é¢ˆæˆ–é…ç½®é—®é¢˜

# åœºæ™¯3: åŸŸåè®¿é—®è¡Œä¸ºåˆ†æ
# 1. é€‰æ‹©ç›®æ ‡è®¾å¤‡ç»„
# 2. æŸ¥çœ‹åŸŸåè®¿é—®è¯¦ç»†ç»Ÿè®¡è¡¨
# 3. åˆ†æè®¿é—®æ¨¡å¼å’Œæµé‡åˆ†å¸ƒ
# 4. è¯†åˆ«å¯ç–‘çš„å¤–éƒ¨è¿æ¥
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
- Network Monitoring Agent (æ•°æ®é‡‡é›†)
- Network Monitoring Server (æ•°æ®èšåˆ)
- Prometheus (æŒ‡æ ‡å­˜å‚¨)
- Grafana (æ•°æ®å¯è§†åŒ–)

```bash
# å¯åŠ¨å®Œæ•´ç›‘æ§æ ˆ
make docker-up-monitoring

# æˆ–ä½¿ç”¨ docker-compose
docker-compose --profile monitoring up -d
```

### 2. å¯¼å…¥ Dashboard

#### æ–¹æ³•ä¸€: è‡ªåŠ¨å¯¼å…¥è„šæœ¬ (æ¨è)

```bash
cd grafana
./import-dashboards.sh
```

#### æ–¹æ³•äºŒ: æ‰‹åŠ¨å¯¼å…¥

1. è®¿é—® Grafana: http://localhost:3000
2. ç™»å½• (admin/admin123)
3. ç‚¹å‡» "+" â†’ "Import"
4. ä¸Šä¼  JSON æ–‡ä»¶æˆ–ç²˜è´´å†…å®¹
5. é…ç½®æ•°æ®æºä¸º "prometheus"
6. ç‚¹å‡» "Import"

### 3. é…ç½®æ•°æ®æº

ç¡®ä¿ Prometheus æ•°æ®æºé…ç½®æ­£ç¡®ï¼š

```yaml
Name: prometheus
Type: Prometheus
URL: http://prometheus:9090  # Docker ç¯å¢ƒ
# æˆ– http://localhost:8080   # ç›´æ¥è®¿é—® Server
Access: Server (default)
```

### 4. éªŒè¯æ•°æ®

```bash
# æ£€æŸ¥æŒ‡æ ‡æ•°æ®
curl http://localhost:8080/metrics | grep network_

# æ£€æŸ¥è®¾å¤‡ä¿¡æ¯
curl http://localhost:8080/metrics | grep network_interface_info
```

## ğŸ“ˆ å…³é”®æŒ‡æ ‡è§£è¯»

### ç½‘ç»œåŸºç¡€æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | å•ä½ | ç”¨é€” |
|------|------|------|------|
| `network_bytes_sent_total` | ç´¯è®¡å‘é€å­—èŠ‚æ•° | bytes | æµé‡ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æ |
| `network_bytes_received_total` | ç´¯è®¡æ¥æ”¶å­—èŠ‚æ•° | bytes | æµé‡ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æ |
| `network_connections_total` | ç´¯è®¡è¿æ¥æ•° | count | è¿æ¥æ´»è·ƒåº¦åˆ†æ |
| `network_interface_info` | ç½‘å¡ä¿¡æ¯ | - | è®¾å¤‡è¯†åˆ«ã€çŠ¶æ€ç›‘æ§ |

### åŸŸåç›¸å…³æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ | å•ä½ | ç”¨é€” |
|------|------|------|------|
| `network_domains_accessed_total` | åŸŸåè®¿é—®æ¬¡æ•° | count | è®¿é—®é¢‘ç‡åˆ†æ |
| `network_domain_bytes_sent_total` | åŸŸåå‘é€å­—èŠ‚æ•° | bytes | åŸŸåæµé‡åˆ†æ |
| `network_domain_bytes_received_total` | åŸŸåæ¥æ”¶å­—èŠ‚æ•° | bytes | åŸŸåæµé‡åˆ†æ |

### é€Ÿç‡è®¡ç®—

æ‰€æœ‰é€Ÿç‡æŒ‡æ ‡éƒ½ä½¿ç”¨ `rate()` å‡½æ•°è®¡ç®—ï¼š

```promql
# å‘é€é€Ÿç‡ (bytes/second)
rate(network_bytes_sent_total[5m])

# è¿æ¥é€Ÿç‡ (connections/second)  
rate(network_connections_total[5m])

# åŸŸåè®¿é—®é€Ÿç‡ (accesses/second)
rate(network_domains_accessed_total[5m])
```

## ğŸ¨ è‡ªå®šä¹‰å’Œæ‰©å±•

### æ·»åŠ æ–°çš„ç›‘æ§é¢æ¿

1. **é€‰æ‹©å¯è§†åŒ–ç±»å‹**
   - Time series: æ—¶é—´åºåˆ—æ•°æ®
   - Stat: å•å€¼ç»Ÿè®¡
   - Table: è¡¨æ ¼æ•°æ®
   - Pie chart: é¥¼å›¾åˆ†å¸ƒ

2. **ç¼–å†™ Prometheus æŸ¥è¯¢**
   ```promql
   # ç¤ºä¾‹: åè®®åˆ†å¸ƒ
   sum by (protocol) (network_connections_total)
   
   # ç¤ºä¾‹: è®¾å¤‡æµé‡æ’è¡Œ
   topk(5, sum by (host) (rate(network_bytes_sent_total[5m])))
   ```

3. **é…ç½®é¢æ¿é€‰é¡¹**
   - è®¾ç½®å•ä½ (bytes, bps, cps)
   - é…ç½®é˜ˆå€¼å’Œé¢œè‰²
   - æ·»åŠ å›¾ä¾‹å’Œæ ‡ç­¾

### åˆ›å»ºå‘Šè­¦è§„åˆ™

```promql
# é«˜æµé‡å‘Šè­¦ (>100MB/s)
rate(network_bytes_sent_total[5m]) > 100*1024*1024

# é«˜è¿æ¥æ•°å‘Šè­¦ (>1000 conn/s)
rate(network_connections_total[5m]) > 1000

# è®¾å¤‡ç¦»çº¿å‘Šè­¦
up{job="network-monitoring"} == 0
```

### ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

1. **ä½¿ç”¨åˆé€‚çš„æ—¶é—´èŒƒå›´**
   ```promql
   # çŸ­æœŸè¶‹åŠ¿: 5m
   rate(network_bytes_sent_total[5m])
   
   # é•¿æœŸè¶‹åŠ¿: 1h
   rate(network_bytes_sent_total[1h])
   ```

2. **é™åˆ¶ç»“æœæ•°é‡**
   ```promql
   # åªæ˜¾ç¤º Top 10
   topk(10, sum by (domain) (network_domains_accessed_total))
   ```

3. **ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤**
   ```promql
   # è¿‡æ»¤ç‰¹å®šä¸»æœº
   network_bytes_sent_total{host="target-host"}
   ```

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. Dashboard æ˜¾ç¤º "No data"

**å¯èƒ½åŸå› **:
- Prometheus æ•°æ®æºé…ç½®é”™è¯¯
- Agent æœªæ­£å¸¸ä¸ŠæŠ¥æ•°æ®
- æ—¶é—´èŒƒå›´è®¾ç½®é—®é¢˜

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥æ•°æ®æºè¿æ¥
curl http://localhost:9090/api/v1/query?query=up

# æ£€æŸ¥ Agent æ•°æ®ä¸ŠæŠ¥
curl http://localhost:8080/metrics | head -20

# æ£€æŸ¥æŒ‡æ ‡æ˜¯å¦å­˜åœ¨
curl http://localhost:8080/metrics | grep network_interface_info
```

#### 2. å˜é‡é€‰æ‹©å™¨ä¸ºç©º

**å¯èƒ½åŸå› **:
- æŒ‡æ ‡ä¸­ç¼ºå°‘å¯¹åº”æ ‡ç­¾
- å˜é‡æŸ¥è¯¢è¯­å¥é”™è¯¯
- æ•°æ®æºé…ç½®é—®é¢˜

**è§£å†³æ–¹æ³•**:
```bash
# æ£€æŸ¥æ ‡ç­¾å€¼
curl -G http://localhost:9090/api/v1/label/host/values

# æµ‹è¯•å˜é‡æŸ¥è¯¢
curl -G http://localhost:9090/api/v1/query \
  --data-urlencode 'query=label_values(network_interface_info, host)'
```

#### 3. å›¾è¡¨æ˜¾ç¤ºå¼‚å¸¸

**å¯èƒ½åŸå› **:
- Prometheus æŸ¥è¯¢è¯­æ³•é”™è¯¯
- æŒ‡æ ‡åç§°æˆ–æ ‡ç­¾é”™è¯¯
- æ•°æ®ç±»å‹ä¸åŒ¹é…

**è§£å†³æ–¹æ³•**:
1. åœ¨ Grafana Query Inspector ä¸­æ£€æŸ¥æŸ¥è¯¢
2. åœ¨ Prometheus UI ä¸­æµ‹è¯•æŸ¥è¯¢è¯­å¥
3. æ£€æŸ¥æŒ‡æ ‡çš„æ•°æ®ç±»å‹å’Œæ ‡ç­¾

### è°ƒè¯•å·¥å…·

```bash
# Grafana æŸ¥è¯¢è°ƒè¯•
# åœ¨é¢æ¿ç¼–è¾‘æ¨¡å¼ä¸‹ç‚¹å‡» "Query Inspector"

# Prometheus æŸ¥è¯¢æµ‹è¯•
# è®¿é—® http://localhost:9090/graph

# æŒ‡æ ‡æ•°æ®æ£€æŸ¥
curl -s http://localhost:8080/metrics | grep -E "network_|agent_"

# æ ‡ç­¾å€¼æŸ¥è¯¢
curl -G http://localhost:9090/api/v1/label/host/values
curl -G http://localhost:9090/api/v1/label/interface/values
```

## ğŸ“š å‚è€ƒèµ„æº

- [Grafana Dashboard æœ€ä½³å®è·µ](https://grafana.com/docs/grafana/latest/best-practices/)
- [Prometheus æŸ¥è¯¢è¯­è¨€æŒ‡å—](https://prometheus.io/docs/prometheus/latest/querying/)
- [ç½‘ç»œç›‘æ§æŒ‡æ ‡è¯´æ˜](../README.md#ç›‘æ§æŒ‡æ ‡)
- [Docker Compose éƒ¨ç½²æŒ‡å—](docker-compose-usage.md)

---

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ [Issue](https://github.com/zhoushoujianwork/go-net-monitoring/issues)ã€‚
