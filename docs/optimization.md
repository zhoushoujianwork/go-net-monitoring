# æ„å»ºä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

- é¿å…é‡å¤æ„å»ºé•œåƒ
- å‡å°‘é•œåƒå¤§å°
- æé«˜æ„å»ºé€Ÿåº¦
- ä¼˜åŒ–Dockerç¼“å­˜åˆ©ç”¨
- ç®€åŒ–æ“ä½œæµç¨‹

## ğŸ”§ ä¼˜åŒ–æªæ–½

### 1. Dockeré•œåƒä¼˜åŒ–

#### é¿å…é‡å¤æ„å»º
**é—®é¢˜**: serverå’Œagentéƒ½ä½¿ç”¨`build: .`ï¼Œå¯¼è‡´ç›¸åŒé•œåƒè¢«æ„å»ºä¸¤æ¬¡

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# ä¼˜åŒ–å‰
server:
  build: .
agent:
  build: .

# ä¼˜åŒ–å
server:
  build: 
    context: .
    dockerfile: Dockerfile
  image: go-net-monitoring:latest
agent:
  image: go-net-monitoring:latest  # å¤ç”¨åŒä¸€é•œåƒ
```

#### å¹¶è¡Œæ„å»º
**ä¼˜åŒ–å‰**: ä¸²è¡Œæ„å»ºä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
```dockerfile
RUN CGO_ENABLED=1 go build -o agent ./cmd/agent
RUN CGO_ENABLED=0 go build -o server ./cmd/server
```

**ä¼˜åŒ–å**: å¹¶è¡Œæ„å»ºï¼Œå‡å°‘æ„å»ºæ—¶é—´
```dockerfile
RUN CGO_ENABLED=1 go build -o agent ./cmd/agent & \
    CGO_ENABLED=0 go build -o server ./cmd/server & \
    wait
```

#### å±‚çº§ä¼˜åŒ–
**ä¼˜åŒ–å‰**: å¤šä¸ªRUNå‘½ä»¤ï¼Œå¢åŠ é•œåƒå±‚æ•°
```dockerfile
RUN apk add --no-cache ca-certificates
RUN addgroup -g 1000 netmon
RUN adduser -D -s /bin/sh -u 1000 -G netmon netmon
RUN mkdir -p /app/data
```

**ä¼˜åŒ–å**: åˆå¹¶åˆ°å•ä¸ªRUNå‘½ä»¤
```dockerfile
RUN apk add --no-cache ca-certificates \
    && addgroup -g 1000 netmon \
    && adduser -D -s /bin/sh -u 1000 -G netmon netmon \
    && mkdir -p /app/data \
    && rm -rf /var/cache/apk/*
```

### 2. æ„å»ºç¼“å­˜ä¼˜åŒ–

#### ä¾èµ–ç¼“å­˜
```dockerfile
# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨Dockerç¼“å­˜
COPY go.mod go.sum ./
RUN go mod download

# æœ€åå¤åˆ¶æºä»£ç ï¼Œé¿å…ä»£ç å˜æ›´å½±å“ä¾èµ–ç¼“å­˜
COPY . .
```

#### .dockerignoreä¼˜åŒ–
åˆ›å»º`.dockerignore`æ–‡ä»¶ï¼Œå‡å°‘æ„å»ºä¸Šä¸‹æ–‡ï¼š
```
.git/
docs/
*.md
logs/
data/
*_test.go
```

### 3. é•œåƒå¤§å°ä¼˜åŒ–

#### åŸºç¡€é•œåƒå‡çº§
- ä»`alpine:3.18`å‡çº§åˆ°`alpine:3.19`
- ä½¿ç”¨æœ€æ–°çš„å®‰å…¨è¡¥ä¸

#### æ¸…ç†ç¼“å­˜
```dockerfile
RUN apk add --no-cache packages \
    && rm -rf /var/cache/apk/*
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### æ„å»ºæ—¶é—´å¯¹æ¯”
| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| é•œåƒæ„å»º | ~2åˆ†é’Ÿ | ~45ç§’ | 60%â†“ |
| é‡å¤æ„å»º | 2æ¬¡å®Œæ•´æ„å»º | 1æ¬¡æ„å»º+å¤ç”¨ | 50%â†“ |

### é•œåƒå¤§å°å¯¹æ¯”
| ç»„ä»¶ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| æœ€ç»ˆé•œåƒ | ~65MB | 45.7MB | 30%â†“ |
| å±‚æ•° | 15å±‚ | 10å±‚ | 33%â†“ |

### æ“ä½œç®€åŒ–
| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| æ„å»º | `docker-compose build` | `make build-optimized` |
| å¯åŠ¨è°ƒè¯• | `DEBUG_MODE=true docker-compose up -d` | `make docker-up-debug` |
| æŸ¥çœ‹æ—¥å¿— | `docker-compose logs -f agent` | `make docker-logs-agent` |

## ğŸ› ï¸ æ–°å¢å·¥å…·

### 1. ä¼˜åŒ–æ„å»ºè„šæœ¬
`scripts/build-optimized.sh`
- è‡ªåŠ¨è·å–ç‰ˆæœ¬ä¿¡æ¯
- æ”¯æŒç¼“å­˜æ¸…ç†
- å†…ç½®æµ‹è¯•åŠŸèƒ½
- å½©è‰²è¾“å‡º

### 2. å¢å¼ºMakefile
æä¾›40+ä¸ªä¾¿æ·å‘½ä»¤ï¼š
```bash
make help              # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‘½ä»¤
make build-optimized   # ä¼˜åŒ–æ„å»º
make docker-up-debug   # è°ƒè¯•æ¨¡å¼å¯åŠ¨
make health           # å¥åº·æ£€æŸ¥
make metrics          # æŸ¥çœ‹æŒ‡æ ‡
```

### 3. .dockerignore
å‡å°‘æ„å»ºä¸Šä¸‹æ–‡ï¼Œæ’é™¤ä¸å¿…è¦æ–‡ä»¶ï¼š
- æ–‡æ¡£æ–‡ä»¶
- æµ‹è¯•æ–‡ä»¶  
- ä¸´æ—¶æ–‡ä»¶
- æ•°æ®ç›®å½•

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹
```bash
# ä¼˜åŒ–æ„å»º
make build-optimized

# å¯åŠ¨æœåŠ¡ (ç”Ÿäº§æ¨¡å¼)
make docker-up

# å¯åŠ¨æœåŠ¡ (è°ƒè¯•æ¨¡å¼)
make docker-up-debug

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
make health

# æŸ¥çœ‹æŒ‡æ ‡
make metrics
```

### å¼€å‘æ¨¡å¼
```bash
# è®¾ç½®å¼€å‘ç¯å¢ƒ
make dev-setup

# è¿è¡ŒServer (å¼€å‘æ¨¡å¼)
make dev-run-server

# è¿è¡ŒAgent (å¼€å‘æ¨¡å¼)
make dev-run-agent
```

### æ¸…ç†æ“ä½œ
```bash
# æ¸…ç†æ„å»ºæ–‡ä»¶
make clean

# æ·±åº¦æ¸…ç† (åŒ…æ‹¬æ•°æ®å’ŒDockerèµ„æº)
make clean-all

# æ¸…ç†Dockerèµ„æº
make docker-clean
```

## ğŸ“ˆ æ€§èƒ½æå‡

### æ„å»ºæ€§èƒ½
- âœ… é¿å…é‡å¤æ„å»ºï¼ŒèŠ‚çœ50%æ„å»ºæ—¶é—´
- âœ… å¹¶è¡Œç¼–è¯‘ï¼Œæé«˜æ„å»ºæ•ˆç‡
- âœ… ä¼˜åŒ–Dockerç¼“å­˜åˆ©ç”¨ç‡

### é•œåƒæ€§èƒ½
- âœ… å‡å°‘30%é•œåƒå¤§å°
- âœ… å‡å°‘33%é•œåƒå±‚æ•°
- âœ… æ›´å¿«çš„é•œåƒæ‹‰å–å’Œå¯åŠ¨

### æ“ä½œæ€§èƒ½
- âœ… ä¸€é”®å¼æ“ä½œï¼Œå‡å°‘å‘½ä»¤å¤æ‚åº¦
- âœ… æ™ºèƒ½ç¼“å­˜ç®¡ç†
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯

## ğŸ” æœ€ä½³å®è·µ

### 1. æ„å»ºç­–ç•¥
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºåˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ
- åˆç†åˆ©ç”¨Dockerå±‚ç¼“å­˜
- å¹¶è¡Œæ„å»ºæé«˜æ•ˆç‡

### 2. é•œåƒä¼˜åŒ–
- ä½¿ç”¨æœ€å°åŒ–åŸºç¡€é•œåƒ
- åˆå¹¶RUNå‘½ä»¤å‡å°‘å±‚æ•°
- åŠæ—¶æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶

### 3. å¼€å‘æµç¨‹
- ä½¿ç”¨Makefileç®€åŒ–æ“ä½œ
- ç¯å¢ƒå˜é‡æ§åˆ¶æ„å»ºè¡Œä¸º
- è‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯

è¿™äº›ä¼˜åŒ–æªæ–½æ˜¾è‘—æå‡äº†æ„å»ºæ•ˆç‡å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¿æŒäº†åŠŸèƒ½çš„å®Œæ•´æ€§å’Œç¨³å®šæ€§ã€‚
